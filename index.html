<html>
<head>
	<title>INFO 3300 - Project 1</title>
	<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="http://d3js.org/topojson.v2.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.21.0/d3-legend.min.js"></script>
	<style>
		div { font-family: 'Montserrat', sans-serif; background-color: #ffffff}
		svg { border: solid #ccc 1px; background-image: url("worldmap.png"); background-size: 100% 100%; background-color: #4b76bc;}
		text { font-size: 7pt; fill: #ccc; }
	</style>
</head>
<body>
	<div id="visualization" style="width: 100%;">
		Sources: http://data.worldbank.org, http://country.io/data/
	</div>

	<script>
		// initial setup script

		var debug = false;
		var footerOffset = 30, sideOffset = 15;
		var mainDiv = d3.select("#visualization");
		var screenHeight = window.innerHeight - footerOffset;
		var screenWidth = window.innerWidth - sideOffset;

		// code for debugs
		if (debug) 
			mainDiv.style("border", "1px solid black");

		// set height to window height
		mainDiv.style("height", screenHeight + 50);
		mainDiv.style("width", screenWidth);

	</script>

	<script src = "CircleGraph.js"></script>
	<script src = "DataFilterer.js"></script>

	<script>
		// data accessing and parsing script

		var birthData;
		var GDPData;

		/* Load the csv data files and then runs a callback to display the data
		*/
		loadData(function(birthData, GDPData, rawCountryData) {
			// filter data by a threshold
			birthData = filterData(birthData,2);
			GDPData = filterData(GDPData,2);

			// cap data so only countries that appear in both dataset will be included
			var cappedDatasets = filterDatasets(birthData, GDPData);
			birthData = cappedDatasets[0];
			GDPData = cappedDatasets[1];

			// combine datasets into one array and display the data
			var combinedData = combineData(2014, birthData, GDPData, rawCountryData);
			displayCombinedData(convertData(combinedData), convertDataNested(combinedData));
		});

		/* Loads and parses the data files and then supplies the callback with the data in a easy to use form*/
		function loadData(callback){
			d3.csv("BirthRate.csv", parseBirth, function(error, data){
				var nestedBirthData = d3.nest()
				.key(function(d) {
					return d.country; 
				})
				.sortKeys(d3.ascending)
				.entries(data);

				d3.csv("GDPPerCap.csv", parseGDP, function(error, data){
					var nestedGDPData = d3.nest()
					.key(function(d) {
						return d.country; 
					})
					.sortKeys(d3.ascending)
					.entries(data);

					d3.json("CountryData.json", function(error, data) {
						callback(nestedBirthData, nestedGDPData, data);
					});
				});
			});
		};

		/* Helper functions for parsing the csv files into useable object*/
		function parseBirth (line) {
			line.country = line['Country Name'];
			return line;
		}

		function parseGDP (line) {
			line.country = line['Country Name'];
			return line;
		}

	</script>

</body>
</html>
