<html>
<head>
	<title>INFO 3300 - Project 1</title>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="http://d3js.org/topojson.v2.min.js"></script>
	<style>
		div { font-family: Arial; color: #ccc }
		svg { border: solid #ccc 1px; }
	</style>
</head>
<body>
	<!--
		Note: to open up server use:
			python -m SimpleHTTPServer 
			python -m http.server
	-->

	<div id="visualization" style="width: 100%;">
		Source: http://data.worldbank.org, http://country.io/data/
	</div>

	<script>
		var debug = false;
		var footerOffset = 30, sideOffset = 15;
		var mainDiv = d3.select("#visualization");
		var screenHeight = window.innerHeight - footerOffset;
		var screenWidth = window.innerWidth - sideOffset;

		// code for debugs
		if (debug) 
			mainDiv.style("border", "1px solid black");

		// set height to window height
		mainDiv.style("height", screenHeight);
		mainDiv.style("width", screenWidth);

	</script>

	<script src = "circleGraphs.js"></script>
	<!--
	<script src = "lineGraphs.js"></script>
	-->

	<script>		
		var birthData;
		var rawBirthData;
		var GDPData;
		var rawGDPData;

		/* Returns true if the countryName is a valid country name false otherwise
		*/ 
		function isValidCountryName(countryName, countryData){
			if(countryData[countryName] == null)
				return false;
			return true;
		}

		/* Returns Combination of all 3 data structures into one array of country object.
			A country object for example may be:
			{
				country: Barbados,
				birthrate: 12341,
				gdp: 412413,
				continent: NA,
				iso2: BB,
			}
		*/
		function combineData(year,birthData,GDPData,continentData){
			var result = [];
			for(var i = 0; i<birthData.length; i++){
				var birthObj = birthData[i].values[0];
				var GDPObj = GDPData[i].values[0];
				var countryName = birthObj.country;

				if (isValidCountryName(countryName, continentData)){
					var birthYear = birthObj[year];
					var GDPYear = GDPObj[year];
					var countryData =  continentData[countryName];

					var combinedObj = {
						key:countryName,
						values:[
							{
								country: countryName,
								birthrate: birthYear,
								gdp: GDPYear,
								continent: countryData[0],
								countrycode: countryData[1]
							}
						]
					}
					result = result.concat([combinedObj]);
				}else{
					console.debug("invalid country name: "+ countryName);
				}
			}
			console.log(result);
			return result;
		}


		/* Load the csv data files and then runs a callback to display the data
		*/
		loadData(function( rawBirthData, birthData, 
						   rawGDPData, GDPData, 
						   rawContinentData) {
			displayCombinedData(combineData(1999, birthData, GDPData, rawContinentData));
		});

		/* Loads and parses the data files and then supplies the callback with the data in a easy to use form*/
		function loadData(callback){
			d3.csv("FilteredBirthRate.csv", parseBirth, function(error, data){
				rawBirthData = data;

				var nestedBirthData = d3.nest()
				.key(function(d) {
					return d.country; 
				})
				.sortKeys(d3.ascending)
				.entries(rawBirthData);

				d3.csv("FilteredGDPPerCap.csv", parseGDP, function(error, data){
					rawGDPData = data;

					var nestedGDPData = d3.nest()
					.key(function(d) {
						return d.country; 
					})
					.sortKeys(d3.ascending)
					.entries(rawGDPData);

					d3.json("countryToContinentMapping.json", function(error, data) {
						callback(rawBirthData, nestedBirthData, rawGDPData, nestedGDPData, data);
					});
				});
			});
		};

		function parseBirth (line) {
			line.country = line['Country Name'];
			return line;
		}

		function parseGDP (line) {
			line.country = line['Country Name'];
			return line;
		}

	</script>

</body>
</html>
